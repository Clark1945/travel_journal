# 系統架構說明

## 整體架構

### 系統層次
```
+-------------------+
|     客戶端        |
+-------------------+
          ↓
+-------------------+
|   負載均衡器      |
+-------------------+
          ↓
+-------------------+
|   OAuth2 服務     |
+-------------------+
          ↓
+--------+  +--------+
| Redis  |  | Google |
+--------+  +--------+
```

## 核心組件

### 1. 安全配置 (SecurityConfig)
- Spring Security 配置
- OAuth2 客戶端配置
- CORS 配置
- 請求過濾器配置

### 2. JWT 提供者 (JwtProvider)
- Token 生成
- Token 驗證
- Token 刷新
- 聲明管理

### 3. OAuth2 處理器
- CustomAuthorizationRequestResolver
  - 自定義授權請求處理
  - 狀態參數管理
  
- OAuth2LoginSuccessHandler
  - 登入成功處理
  - Token 生成
  - 用戶資訊保存

### 4. 用戶服務 (CustomOAuth2UserService)
- OAuth2 用戶信息加載
- 用戶資料映射
- 權限管理

### 5. Redis 配置 (RedisConfig)
- Session 存儲
- Token 黑名單
- 速率限制

## 數據流

### 1. 登入流程
```
用戶 → 登入請求 → OAuth2 服務 → Google
     ← 授權碼   ← OAuth2 服務 ← Google
     → 授權碼   → OAuth2 服務 → 驗證
     ← JWT Token← OAuth2 服務
```

### 2. Token 刷新流程
```
用戶 → Refresh Token → 驗證
     ← 新 Access Token
```

### 3. API 訪問流程
```
用戶 → API 請求 + Token → Token 驗證 → 處理請求
     ← 響應          ← 結果返回
```

## 安全機制

### 1. 認證層
- JWT based 認證
- OAuth2 社交登入
- Token 刷新機制

### 2. 授權層
- 基於角色的訪問控制 (RBAC)
- URL 級別權限控制
- 方法級別安全性

### 3. 數據安全
- HTTPS 傳輸加密
- 密碼加密存儲
- 敏感數據脫敏

## 擴展性設計

### 1. 水平擴展
- 無狀態設計
- Redis 分布式 Session
- 負載均衡就緒

### 2. 功能擴展
- 模塊化設計
- 插件式架構
- 事件驅動設計

### 3. 集成能力
- REST API 支持
- 微服務相容
- 事件總線集成

## 監控與維護

### 1. 日誌系統
- 操作日誌
- 安全日誌
- 性能日誌

### 2. 監控指標
- API 響應時間
- 系統資源使用
- 錯誤率統計

### 3. 告警機制
- 異常監控
- 性能監控
- 安全監控

## 部署架構

### 開發環境
```
單機部署
- 應用服務器
- Redis (單例)
```

### 測試環境
```
基礎集群
- 2x 應用服務器
- Redis (主從)
- 負載均衡器
```

### 生產環境
```
高可用集群
- 4x+ 應用服務器
- Redis 集群
- 負載均衡器 (主備)
- 監控系統
```

## 技術債務與優化

### 當前限制
1. 單一社交登入提供者
2. 同步 API 調用
3. 簡單的緩存策略

### 優化方向
1. 多社交平台支持
2. 異步處理機制
3. 多級緩存架構
4. 性能優化
5. 安全強化

## 災難恢復

### 備份策略
1. Redis 數據定時備份
2. 配置文件備份
3. 日誌備份

### 恢復流程
1. 系統故障恢復流程
2. 數據恢復流程
3. 服務降級策略 